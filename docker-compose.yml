version: "3.9"  # Docker Compose ë²„ì „ ì •ì˜

services:
  # Redis ì»¨í…Œì´ë„ˆ ì •ì˜ (ì¢Œì„ ìºì‹œ ë° ë¶„ì‚°ë½ ì²˜ë¦¬) - ì´ˆê¸° ê°œë°œ ~ ìµœì¢… ë°°í¬ê¹Œì§€ ê³„ì† ì‚¬ìš©
  redis-cache:
    image: redis:7.0-alpine  # Redis ê³µì‹ ê²½ëŸ‰ ì´ë¯¸ì§€ ì‚¬ìš©
    container_name: redis-cache  # ë¡œì»¬ì—ì„œ í™•ì¸í•  ì»¨í…Œì´ë„ˆ ì´ë¦„
    ports:
      - "6379:6379"  # í˜¸ìŠ¤íŠ¸ â†” ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë§¤í•‘
    command: redis-server --save 60 1 --appendonly yes  # Redis ì„œë²„ ì‹¤í–‰ ì‹œ ì ìš©í•  ëª…ë ¹ì–´(ì €ì¥ ì •ì±… + AOF ì˜ì†ì„± ì„¤ì •)
    # --save 60 1: 60ì´ˆ ë™ì•ˆ 1ê°œ ì´ìƒì˜ í‚¤ê°€ ë³€ê²½ë˜ë©´ ë””ìŠ¤í¬ì— ì €ì¥(ìŠ¤ëƒ…ìƒ·)
    # --appendonly yes: ëª¨ë“  ì“°ê¸° ëª…ë ¹ì„ íŒŒì¼ì— ê¸°ë¡í•˜ì—¬ ë°ì´í„° ì˜ì†ì„± ê°•í™”(AOF)
    volumes:
      - redis-data:/data  # ë¡œì»¬ Docker ë³¼ë¥¨ì— ë°ì´í„° ë³´ì¡´('redis-data'ë¼ëŠ” Docker ë³¼ë¥¨ì„ ì»¨í…Œì´ë„ˆì˜ /data ë””ë ‰í† ë¦¬ì— ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆê°€ ì‚­ì œë˜ì–´ë„ Redis ë°ì´í„°ê°€ ë³´ì¡´ë©ë‹ˆë‹¤.)
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]  # í—¬ìŠ¤ì²´í¬ - ping â†’ pong
      interval: 5s
      timeout: 3s
      retries: 5

  # LocalStack ì»¨í…Œì´ë„ˆ (AWS ì„œë¹„ìŠ¤ ëª¨í‚¹: SQS, S3 ë“±) - ì´ˆê¸° ê°œë°œ ~ AWS ë§ˆì´ê·¸ë ˆì´ì…˜ ì§ì „ê¹Œì§€
  localstack:
    image: localstack/localstack:latest # ì‚¬ìš©í•  Docker ì´ë¯¸ì§€ (ìµœì‹  ë²„ì „ì˜ LocalStack)
    container_name: localstack  # ì»¨í…Œì´ë„ˆì— ë¶€ì—¬í•  ê³ ìœ í•œ ì´ë¦„
    ports:
      - "4566:4566"  # LocalStackì˜ ëª¨ë“  AWS ì„œë¹„ìŠ¤ ê³µí†µ í¬íŠ¸
    environment:
      - SERVICES=sqs  # ì‚¬ìš©í•  AWS ëª¨í‚¹ ì„œë¹„ìŠ¤ë§Œ ì§€ì •. í•„ìš”í•œ ê²ƒë§Œ ëª…ì‹œí•˜ë©´ ë” ê°€ë³ê²Œ ì‹¤í–‰ë¨ (í˜„ì¬ ì„¤ì •: sqsë§Œ ì‚¬ìš©)  #lambda,s3
      - AWS_DEFAULT_REGION=ap-northeast-2  # ê¸°ë³¸ ë¦¬ì „
      - INIT_SCRIPTS_PATH=/docker-entrypoint-initaws.d  # ì´ˆê¸° ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜(ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ ì‹¤í–‰)
      - EAGER_SERVICE_LOADING=0  # ëŠë¦¬ê²Œ ë¡œë”© (ë¶ˆí•„ìš”í•œ ìì› ë‚­ë¹„ ë°©ì§€, 0ì´ ê¸°ë³¸ê°’)
      - DEBUG=0  # ë””ë²„ê¹… ë¹„í™œì„±í™”
    volumes:
      - ./localstack-init:/docker-entrypoint-initaws.d  # ì´ˆê¸° í ìƒì„± ìŠ¤í¬ë¦½íŠ¸ mount
        # PCì˜ ./localstack-init í´ë”ë¥¼ ì»¨í…Œì´ë„ˆì˜ ì§€ì •ëœ ê²½ë¡œì— ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
      # ./localstack-init í´ë”ì— ì‰˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë„£ì–´ë‘ë©´, ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ SQS í ìƒì„± ë“±ì„ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    healthcheck:
      test: [ "CMD-SHELL", "awslocal sqs list-queues" ]  # SQS í ë¦¬ìŠ¤íŠ¸ ëª…ë ¹ì´ ì‹¤í–‰ë˜ë©´ OK(SQSê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í™•ì‹¤í•œ ë°©ë²•)
      interval: 5s
      timeout: 5s
      retries: 5

  # âœ… Nginx ì»¨í…Œì´ë„ˆ - í”„ë¡ì‹œ(Reverse Proxy) + ë¡œë“œë°¸ëŸ°ì„œ ì—­í•  (ì˜ˆì •) (í†µí•© ê²Œì´íŠ¸ì›¨ì´)
  #   - í›„ê¸° ë°°í¬ ë‹¨ê³„ (AWS ìƒì—ì„œ ë¡œë“œë°¸ëŸ°ì„œë¡œ ì—­í• í•  ë•Œ ì£¼ì„ í•´ì œ)
  #   â†’ ë‚´ë¶€ì—ì„œ ì•± ì •ìƒ ì‘ë™í•˜ê³  ë‚˜ë©´ í”„ë¡ì‹œ êµ¬ì„± ì‹œ í•´ì œ
  #  nginx:
  #    image: nginx:alpine
  #    container_name: nginx-lb
  #    ports:
  #      - "80:80"  # ì™¸ë¶€ì˜ 80ë²ˆ í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆì˜ 80ë²ˆ í¬íŠ¸ì— ì—°ê²°(ì™¸ë¶€ í¬íŠ¸ â†’ ë‚´ë¶€ í¬íŠ¸ë¡œ ëª¨ë“  HTTP ìš”ì²­ ìˆ˜ì‹ )
  #    volumes:
  #      - ./nginx.conf:/etc/nginx/conf.d/default.conf  # í˜„ì¬ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìˆëŠ” nginx.conf ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œë¡œ ë§ˆìš´íŠ¸
  #    depends_on:
  #      app:
  #        condition: service_healthy  # app ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ëœ í›„ì— nginxê°€ ì‹œì‘

  # ğŸ’¤ WebSocket ì„œë²„ (ì¢Œì„ í˜„í™© ì‹¤ì‹œê°„ ë°˜ì˜) - ì¤‘ê¸° í†µí•© í…ŒìŠ¤íŠ¸ ë˜ëŠ” í›„ê¸° ë‹¨ê³„ì—ì„œ êµ¬í˜„ ì—¬ìœ  ìˆì„ ì‹œ í•´ì œ
  # app-websocket:
  #   build: .  # í˜„ì¬ ë””ë ‰í† ë¦¬ì— Dockerfileì´ ìˆë‹¤ê³  ê°€ì •
  #   container_name: websocket-server
  #   ports:
  #     - "8081:8081"  # WebSocket ì „ìš© í¬íŠ¸
  #   environment:
  ##       - SPRING_PROFILES_ACTIVE=docker
  ##       - SERVER_PORT=8081
  ##       - SPRING_DATASOURCE_URL
  ##       - SPRING_DATASOURCE_USERNAME
  ##       - SPRING_DATASOURCE_PASSWORD
  ##       - SPRING_DATA_REDIS_HOST
  ##       - SPRING_DATA_REDIS_PORT
  ##       - SQS_ENDPOINT=http://localstack:4566
  #
  #   depends_on:
  #     redis-cache:
  #       condition: service_healthy
  #     localstack:
  #       condition: service_healthy
  #   healthcheck:
  #     test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 3

  # âš™ï¸ Spring Boot Application (app) (ë°±ì—”ë“œ ì„œë²„)
  #   - ì¤‘ê¸° í†µí•© í…ŒìŠ¤íŠ¸ ~ í›„ê¸° ë°°í¬ê¹Œì§€ ì‚¬ìš©
  #   â†’ localstack + redis + Aiven ì„¸íŒ… í™•ì¸ í›„ ì£¼ì„ í•´ì œ
  app:
    build: .
    # í¬íŠ¸í¬ì›Œë”©ì€ Nginxê°€ ë‹´ë‹¹í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œ
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_OPTS=-Xmx512m -XX:MaxRAMPercentage=50.0   # ë©”ëª¨ë¦¬ ì œí•œ ëª…ì‹œì  ì„¤ì •

      # .env íŒŒì¼ì—ì„œ ì•„ë˜ ë³€ìˆ˜ë“¤ì˜ ê°’ì„ ìë™ìœ¼ë¡œ ì½ì–´ì˜´
      #        - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${SERVER_PORT}
      - DB_URL=${DB_URL}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT}
      - SPRING_DATA_REDIS_USERNAME=${SPRING_DATA_REDIS_USERNAME}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - SUPABASE_PROFILE_BUCKET=${SUPABASE_PROFILE_BUCKET}
      - SUPABASE_POSTER_BUCKET=${SUPABASE_POSTER_BUCKET}
      - SUPABASE_DOCS_BUCKET=${SUPABASE_DOCS_BUCKET}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_EXPIRATION_MS=${JWT_EXPIRATION_MS}
      - SQS_ENDPOINT=http://localstack:4566  # ë˜ëŠ” ${SQS_ENDPOINT} ì¤‘ íƒ 1
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}

      # Localstack SQS ì—”ë“œí¬ì¸íŠ¸
      - SQS_ENDPOINT=http://localstack:4566

    depends_on:
      #      mysql-db:
      #        condition: service_healthy
      localstack:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 768M

  # âš ï¸ MySQL (ë¡œì»¬ ê°œë°œ ë° ì¤‘ê¸° í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ Aiven ì¥ì•  ì‹œ ì„ì‹œ ëŒ€ì‘ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©)
  # - Aiven ë˜ëŠ” RDS ì‚¬ìš© ì‹œ ì£¼ì„ ìœ ì§€ (ì‚¬ìš© ì•ˆ í•¨)
  # - AWS ë§ˆì´ê·¸ë ˆì´ì…˜(í›„ê¸°) ë‹¨ê³„ì—ì„œëŠ” ì™„ì „ ì œì™¸ë¨ (RDS -> AWSê°€ ì œê³µí•˜ëŠ” ì™„ì „ê´€ë¦¬í˜• DB ì„œë¹„ìŠ¤)
  # - ì¦‰, ì´ˆê¸°ë¶€í„° í›„ê¸°ê¹Œì§€ ëŒ€ë¶€ë¶„ ì£¼ì„ ìƒíƒœ ìœ ì§€ (ì˜ˆì™¸ì  ìƒí™©ì—ë§Œ í•´ì œ)
#  mysql-db:
#    image: mysql:8.0   # ì‚¬ìš©í•  Docker ì´ë¯¸ì§€ (ìµœì‹  ë²„ì „ì˜ MySQL)
#    container_name: mysql-db   # ì»¨í…Œì´ë„ˆì— ë¶€ì—¬í•  ê³ ìœ í•œ ì´ë¦„
#    ports:
#      - "3306:3306"    # PC(Host)ì˜ 3306 í¬íŠ¸ì™€ ì»¨í…Œì´ë„ˆì˜ 3306 í¬íŠ¸ë¥¼ ì—°ê²°
#    environment:
#      MYSQL_ROOT_PASSWORD: rootpass    # MySQL root ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •
#      MYSQL_DATABASE: ticketing_db     # ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ìƒì„±í•  ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ì„ ì„¤ì •
#      TZ: Asia/Seoul
#    volumes:
#      - mysql-data:/var/lib/mysql
#    healthcheck:   # í—¬ìŠ¤ ì²´í¬ ì¶”ê°€
#      test: [ "CMD", "mysqladmin", "ping", "-uroot", "-prootpass" ]
#      interval: 5s
#      timeout: 3s
#      retries: 10

# ë³¼ë¥¨ ì„ ì–¸ë¶€ (ì‚­ì œ ì‹œì—ë„ ë°ì´í„°ëŠ” ìœ ì§€)
volumes:
  redis-data:  # Redis ë°ì´í„° ì €ì¥ìš© ('redis-data' ë¼ëŠ” ì´ë¦„ì˜ Docker Named Volumeì„ ì„ ì–¸)
  mysql-data:  # MySQL ë³¼ë¥¨ë„ ë¯¸ë¦¬ ì •ì˜ (ì‹¤ì œ ì‚¬ìš©ì€ ì•ˆí•¨)