name: Deploy to EC2

on:
  # 'Backend CI Pipeline' ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆì„ ë•Œë§Œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows: [ "Backend CI Pipeline" ]  # backend-ci.yml íŒŒì¼ì˜ 'name' ì†ì„± ê°’
    types:
      - completed # 'Backend CI Pipeline'ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ (ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€)

jobs:
  deploy:
    # 'Backend CI Pipeline' ì›Œí¬í”Œë¡œìš°ì˜ ê²°ê³¼ê°€ 'success'ì¼ ë•Œë§Œ 'deploy' job ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest # AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°í•˜ê¸° ìœ„í•œ ì‹¤í–‰ í™˜ê²½

    steps:
      - name: Connect to EC2 and Deploy Docker Container
        uses: appleboy/ssh-action@v0.1.6 # SSH ì ‘ì†ì„ ìœ„í•œ GitHub Action ì‚¬ìš©
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ í¼ë¸”ë¦­ IP ë˜ëŠ” DNS (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          username: ${{ secrets.EC2_USER }} # EC2 ì¸ìŠ¤í„´ìŠ¤ ì ‘ì† ì‚¬ìš©ìëª… (ì˜ˆ: ec2-user)
          key: ${{ secrets.EC2_KEY }} # EC2 ì ‘ì†ìš© í”„ë¼ì´ë¹— í‚¤ (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          port: 22 # SSH ê¸°ë³¸ í¬íŠ¸

          # ì´ script ë¸”ë¡ ë‚´ì˜ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ ê°’ë“¤ì€ ë”°ì˜´í‘œë¡œ ê°ì‹¸ì•¼ í•©ë‹ˆë‹¤.
          # ì´ëŠ” bash ì‰˜ì˜ íŠ¹ìˆ˜ ë¬¸ì í•´ì„ ë¬¸ì œë¥¼ ë°©ì§€í•˜ê³ , ì‹œí¬ë¦¿ ê°’ì— ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ ë¬¸ìê°€ í¬í•¨ë  ê²½ìš°ì—ë„ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
          script: |
            set -xe
            echo "EC2 ì ‘ì† ì™„ë£Œ. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker stop ticketmon-backend || true
            docker rm ticketmon-backend || true

            echo "ğŸ—‘ï¸ ì´ì „ Docker ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            # ì£¼ì˜: ì´ ëª…ë ¹ì€ 'ticketmon-backend'ì™€ ê´€ë ¨ëœ ì´ë¯¸ì§€ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.
            # ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ë ¤ë©´ 'docker rmi $(docker images -q)'ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì´ëŠ” ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜
            IMAGE_ID=$(docker images -q ghcr.io/${{ secrets.DOCKER_IMAGE_REPO }}:latest)
            if [ -n "$IMAGE_ID" ]; then
              docker rmi $IMAGE_ID || true
              echo "âœ… ì´ì „ ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ: $IMAGE_ID"
            else
              echo "â„¹ï¸ ì‚­ì œí•  ì´ì „ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."
            fi
            
            echo "ğŸ” GHCR ë¡œê·¸ì¸ ì¤‘..."
            # GHCR ë¡œê·¸ì¸ (GitHub Actions ê¸°ë³¸ í† í° ì‚¬ìš©)
            # DOCKER_USERNAME ëŒ€ì‹  github.actorë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "â¬‡ï¸ ìµœì‹  Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            # DOCKER_IMAGE_REPO secretì—ëŠ” 'ì¡°ì§ëª…/ë ˆí¬ì§€í† ë¦¬ëª…' ì „ì²´ê°€ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤ (ì˜ˆ:'aibe-3team/aibe1-finalproject-team03_be-aws-migration-test')
            docker pull ghcr.io/${{ secrets.DOCKER_IMAGE_REPO }}:latest # ìˆ˜ì •ëœ ì´ë¯¸ì§€ ê²½ë¡œ ì‚¬ìš©
            echo "ğŸš€ ìƒˆ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            # ëª¨ë“  -e ì˜µì…˜ì˜ ê°’ì„ ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ì‰˜ ë¬¸ë²• ì˜¤ë¥˜ ë°©ì§€
            docker run -d \
              --name ticketmon-backend \
              -p 80:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e SPRING_DATA_REDIS_HOST="${{ secrets.SPRING_DATA_REDIS_HOST }}" \
              -e SPRING_DATA_REDIS_PORT="${{ secrets.SPRING_DATA_REDIS_PORT }}" \
              -e SPRING_DATA_REDIS_USERNAME="${{ secrets.SPRING_DATA_REDIS_USERNAME }}" \
              -e SPRING_DATA_REDIS_PASSWORD="${{ secrets.SPRING_DATA_REDIS_PASSWORD }}" \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              -e JWT_ACCESS_EXPIRATION_MS="${{ secrets.JWT_ACCESS_EXPIRATION_MS }}" \
              -e JWT_REFRESH_EXPIRATION_MS="${{ secrets.JWT_REFRESH_EXPIRATION_MS }}" \
              -e SQS_ENDPOINT="${{ secrets.SQS_ENDPOINT }}" \
              -e TOSS_CLIENT_KEY="${{ secrets.TOSS_CLIENT_KEY }}" \
              -e TOSS_SECRET_KEY="${{ secrets.TOSS_SECRET_KEY }}" \
              -e TOGETHER_API_KEY="${{ secrets.TOGETHER_API_KEY }}" \
              -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              -e NAVER_CLIENT_ID="${{ secrets.NAVER_CLIENT_ID }}" \
              -e NAVER_CLIENT_SECRET="${{ secrets.NAVER_CLIENT_SECRET }}" \
              -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
              -e KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}" \
              -e BASE_URL="${{ secrets.BASE_URL }}" \
              -e ONESIGNAL_API_KEY="${{ secrets.ONESIGNAL_API_KEY }}" \
              -e ONESIGNAL_APP_ID="${{ secrets.ONESIGNAL_APP_ID }}" \
              -e FRONT_BASE_URL="${{ secrets.FRONT_BASE_URL }}" \
              ghcr.io/${{ secrets.DOCKER_IMAGE_REPO }}:latest
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"