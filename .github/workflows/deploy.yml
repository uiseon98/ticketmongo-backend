# 워크플로우의 이름
name: Backend CI/CD

# 워크플로우 실행 조건: main 브랜치에 push 이벤트 발생 시
on:
  push:
    branches: [ "main" ]

# 실행될 작업(job) 목록
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. JDK 17 설치
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 3. Gradle 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Spring Boot 애플리케이션 빌드 (GitHub Packages 인증 정보 주입)
      - name: Build with Gradle
        env:
          GH_PACKAGES_USER: ${{ github.actor }}         # GitHub 사용자 이름
          GH_PACKAGES_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub Actions 자동 생성 토큰
        run: ./gradlew build -x test

      # 5. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }} # Docker Hub Access Token

      # 6. Docker 이미지 빌드 및 푸시 (build secret 사용)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_IMAGE_REPO }}:latest
          no-cache: true
          secrets: |
            "gradle=type=file,content=gpr.user=${{ github.actor }}\ngpr.key=${{ secrets.GITHUB_TOKEN }}"

      # 7. EC2에 접속하여 배포
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # 기존 컨테이너 중지 및 삭제
            docker stop ticketmongo-backend || true
            docker rm ticketmongo-backend || true
            
            # Docker Hub에서 최신 이미지 받기
            docker pull ${{ secrets.DOCKER_IMAGE_REPO }}:latest

            # Docker 컨테이너 실행 (GitHub Secrets의 환경변수를 컨테이너에 주입)
            docker run -d --name ticketmongo-backend -p 80:8080 \
              -e BASE_URL="${{ secrets.BASE_URL }}" \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e FRONT_BASE_URL="${{ secrets.FRONT_BASE_URL }}" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              -e JWT_ACCESS_EXPIRATION_MS="${{ secrets.JWT_ACCESS_EXPIRATION_MS }}" \
              -e JWT_REFRESH_EXPIRATION_MS="${{ secrets.JWT_REFRESH_EXPIRATION_MS }}" \
              -e ONESIGNAL_API_KEY="${{ secrets.ONESIGNAL_API_KEY }}" \
              -e ONESIGNAL_APP_ID="${{ secrets.ONESIGNAL_APP_ID }}" \
              -e SPRING_DATA_REDIS_HOST="${{ secrets.SPRING_DATA_REDIS_HOST }}" \
              -e SPRING_DATA_REDIS_PORT="${{ secrets.SPRING_DATA_REDIS_PORT }}" \
              -e SPRING_DATA_REDIS_SSL="${{ secrets.SPRING_DATA_REDIS_SSL }}" \
              -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
              -e KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}" \
              -e NAVER_CLIENT_ID="${{ secrets.NAVER_CLIENT_ID }}" \
              -e NAVER_CLIENT_SECRET="${{ secrets.NAVER_CLIENT_SECRET }}" \
              -e TOSS_CLIENT_KEY="${{ secrets.TOSS_CLIENT_KEY }}" \
              -e TOSS_SECRET_KEY="${{ secrets.TOSS_SECRET_KEY }}" \
              -e TOGETHER_API_KEY="${{ secrets.TOGETHER_API_KEY }}" \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              ${{ secrets.DOCKER_IMAGE_REPO }}:latest

      # 8. Discord 알림 (배포 성공/실패 시)
      - name: Discord Notification
        if: always()
        uses: appleboy/discord-action@master
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            **Backend CI/CD Status: ${{ job.status }}**
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>