name: Deploy to EC2

on:
  workflow_run:
    workflows: [ "Backend CI Pipeline" ]
    types: [ completed ]
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Docker container to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            set -xe
            echo "===== Docker Login ====="
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            echo "===== Docker Pull ====="
            docker pull ghcr.io/${{ github.repository }}:latest

            echo "===== Stop/Remove Old Container ====="
            docker stop ticketmon-backend || true
            docker rm ticketmon-backend || true

            echo "===== Run New Container ====="
            docker run -d --name ticketmon-backend -p 80:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              -e JWT_ACCESS_EXPIRATION_MS="${{ secrets.JWT_ACCESS_EXPIRATION_MS }}" \
              -e JWT_REFRESH_EXPIRATION_MS="${{ secrets.JWT_REFRESH_EXPIRATION_MS }}" \
              -e BASE_URL="${{ secrets.BASE_URL }}" \
              -e FRONT_BASE_URL="${{ secrets.FRONT_BASE_URL }}" \
              ghcr.io/${{ github.repository }}:latest
            echo "üéâ Î∞∞Ìè¨ ÏôÑÎ£å!"
