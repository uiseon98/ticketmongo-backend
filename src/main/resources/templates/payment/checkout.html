<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>ê²°ì œ ìš”ì²­</title>
    <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  v1 ê²°ì œì°½ SDK ì¶”ê°€ -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
</head>
<body>
<h1>ê²°ì œí•˜ê¸°</h1>
<div th:if="${errorMessage}"><p style="color:red;" th:text="${errorMessage}"></p></div>
<div th:unless="${errorMessage}">
    <label for="booking-select">ê²°ì œí•  ì˜ˆë§¤ ì„ íƒ:</label>
    <select id="booking-select">
        <option value="">-- ê²°ì œí•  ì˜ˆë§¤ ì„ íƒ --</option>
        <th:block th:each="b : ${bookings}">
            <option th:value="${b.bookingNumber}" th:text="|${b.concert.title} (${b.bookingNumber})|"></option>
        </th:block>
    </select>
    <button id="payment-button" disabled>ê²°ì œ</button>
</div>

<script th:inline="javascript">
    const bookingSelect = document.getElementById('booking-select');
    const paymentButton = document.getElementById('payment-button');

    // ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] tossPayments ê°ì²´ëŠ” API ì‘ë‹µ í›„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
    let tossPayments = null; // ì´ˆê¸°í™” ì „ì—ëŠ” nullë¡œ ì„ ì–¸

    bookingSelect.addEventListener('change', () => paymentButton.disabled = !bookingSelect.value);

    paymentButton.addEventListener('click', async () => {
        const bookingNumber = bookingSelect.value;
        if (!bookingNumber) return;

        try {
            const response = await fetch('/api/v1/payments/request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({bookingNumber})
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ê²°ì œ ì •ë³´ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            const paymentData = await response.json();

            // ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] ì—¬ê¸°ì„œ tossPayments ê°ì²´ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            // clientKeyê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì—¬ê¸°ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            tossPayments = TossPayments(paymentData.clientKey);

            // ğŸ’¡ [ì¶”ê°€] tossPayments ê°ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            if (!tossPayments) {
                throw new Error('TossPayments SDK ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. clientKeyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }

            tossPayments.requestPayment('ì¹´ë“œ', {
                amount: paymentData.amount,
                orderId: paymentData.orderId,
                orderName: paymentData.orderName,
                customerName: paymentData.customerName,
                successUrl: paymentData.successUrl,
                failUrl: paymentData.failUrl
            })
                .catch(function (error) {
                    // error.codeê°€ 'USER_CANCEL'ì´ë©´ ì‚¬ìš©ìê°€ ì§ì ‘ ì°½ì„ ë‹«ì€ ê²½ìš°
                    if (error.code === 'USER_CANCEL') {
                        console.log('ì‚¬ìš©ìê°€ ê²°ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
                        // ìˆ˜ë™ìœ¼ë¡œ fail í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        // orderIdë¥¼ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, í˜„ì¬ ì„ íƒëœ bookingNumberë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬
                        window.location.href = '/payment/result/fail?orderId=' + paymentData.orderId
                            + '&code=' + error.code
                            + '&message=' + encodeURIComponent('ì‚¬ìš©ìê°€ ê²°ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
                    } else {
                        // ê·¸ ì™¸ ë‹¤ë¥¸ ê²°ì œ ì˜¤ë¥˜ (ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë“±)
                        console.error('ê²°ì œ ì˜¤ë¥˜:', error.message);
                        window.location.href = '/payment/result/fail?orderId=' + paymentData.orderId
                            + '&message=' + encodeURIComponent('ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                });

        } catch (error) {
            alert(error.message);
        }
    });
</script>
</body>
</html>
